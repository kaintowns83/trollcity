
import React, { useEffect, useState } from "react";
import { Link, useLocation } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Home, Radio, Heart, User, TrendingUp, Coins, ShoppingBag, DollarSign, Shield, Swords, Trophy, Crown, Gift, Calendar, MessageCircle, Bell, X, Users, Flame, ChevronDown, Sparkles } from "lucide-react";
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarHeader,
  SidebarFooter,
  SidebarProvider,
  SidebarTrigger,
  useSidebar,
} from "@/components/ui/sidebar";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { base44 } from "@/api/base44Client";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import AgeVerification from "@/components/AgeVerification";
import OGBadge from "@/components/OGBadge";
import { toast } from "sonner"; // Changed from react-hot-toast

function SidebarContentComponent({ user }) {
  const location = useLocation();
  const { setOpenMobile } = useSidebar();
  const [openSections, setOpenSections] = useState({
    main: true,
    discover: true,
    monetization: true,
    profile: true
  });

  const { data: unreadMessagesCount = 0 } = useQuery({
    queryKey: ['unreadMessagesCount', user?.id],
    queryFn: async () => {
      if (!user) return 0;
      try {
        const conv1 = await base44.entities.Conversation.filter({ participant1_id: user.id });
        const conv2 = await base44.entities.Conversation.filter({ participant2_id: user.id });
        const unread1 = conv1.reduce((sum, conv) => sum + (conv.unread_count_p1 || 0), 0);
        const unread2 = conv2.reduce((sum, conv) => sum + (conv.unread_count_p2 || 0), 0);
        return unread1 + unread2;
      } catch (error) {
        console.error("Error fetching unread messages:", error);
        return 0;
      }
    },
    enabled: !!user,
    refetchInterval: 30000, // Every 30 seconds - reduced from 10s to prevent rate limiting
  });

  const { data: unreadNotificationsCount = 0 } = useQuery({
    queryKey: ['unreadNotificationsCount', user?.id],
    queryFn: async () => {
      if (!user) return 0;
      try {
        const notifications = await base44.entities.Notification.filter({
          user_id: user.id,
          is_read: false
        });
        return notifications.length;
      } catch (error) {
        console.error("Error fetching unread notifications:", error);
        return 0;
      }
    },
    enabled: !!user,
    refetchInterval: 30000, // Every 30 seconds - reduced from 10s to prevent rate limiting
  });

  const handleLinkClick = () => {
    setOpenMobile(false);
  };

  const toggleSection = (section) => {
    setOpenSections(prev => ({ ...prev, [section]: !prev[section] }));
  };

  const getTierInfo = (level) => {
    if (level >= 1 && level <= 9) return { tier: 1, color: "from-gray-500 to-slate-500" };
    if (level >= 10 && level <= 19) return { tier: 2, color: "from-blue-500 to-cyan-500" };
    if (level >= 20 && level <= 29) return { tier: 3, color: "from-purple-500 to-pink-500" };
    if (level >= 30) return { tier: 4, color: "from-yellow-500 to-orange-500" };
    return { tier: 1, color: "from-gray-500 to-slate-500" };
  };

  const userLevel = user?.level || 1;
  const tierInfo = getTierInfo(userLevel);

  // Refactored navigation items into categories
  const mainNavItems = [
    { title: "Discover", url: createPageUrl("Home"), icon: Home },
    { title: "Following", url: createPageUrl("Following"), icon: Heart },
    { title: "Find Users", url: createPageUrl("UserSearch"), icon: Users },
    { title: "Messages", url: createPageUrl("Messages"), icon: MessageCircle, badge: unreadMessagesCount },
    { title: "Notifications", url: createPageUrl("Notifications"), icon: Bell, badge: unreadNotificationsCount },
  ];

  const discoverNavItems = [
    { title: "Trending", url: createPageUrl("Trending"), icon: TrendingUp },
    { title: "Leaderboards", url: createPageUrl("Leaderboards"), icon: Trophy },
    { title: "Best Trollerz", url: createPageUrl("BestTrollerz"), icon: Flame },
    { title: "Singing Battle", url: createPageUrl("TrollerzBattle"), icon: Swords },
  ];

  const monetizationNavItems = [
    { title: "Store", url: createPageUrl("Store"), icon: ShoppingBag },
    { title: "Earnings", url: createPageUrl("Earnings"), icon: DollarSign },
    { title: "Referrals", url: createPageUrl("Referrals"), icon: Users },
    { title: "Troll Family", url: createPageUrl("TrollFamily"), icon: Users },
    { title: "Broadcaster", url: createPageUrl("BroadcasterApplication"), icon: Crown },
    { title: "Daily Rewards", url: createPageUrl("Rewards"), icon: Calendar },
    { title: "Subscriptions", url: createPageUrl("Subscriptions"), icon: Crown },
    { title: "Tips", url: createPageUrl("Tips"), icon: Gift },
    { title: "Custom Gift", url: createPageUrl("CustomGiftApplication"), icon: Sparkles },
  ];

  const profileNavItems = [
    { title: "My Profile", url: createPageUrl("Profile"), icon: User },
    { title: "Manage Followers", url: createPageUrl("ManageFollowers"), icon: Users },
    { title: "Updates", url: createPageUrl("Updates"), icon: Sparkles },
    { title: "Privacy Policy", url: createPageUrl("PrivacyPolicy"), icon: Shield },
    { title: "Disclaimer", url: createPageUrl("Disclaimer"), icon: Shield },
  ];

  // Add Troll Officer application for non-officers AND admin
  if (user && (!user.is_troll_officer || user.role === 'admin')) {
    profileNavItems.push({
      title: "Troll Officer",
      url: createPageUrl("TrollOfficerApplication"),
      icon: Shield
    });
  }

  const renderNavItems = (items) => (
    items.map((item) => (
      <SidebarMenuItem key={item.title} className="mb-1">
        <SidebarMenuButton
          asChild
          className={`hover:bg-purple-500/20 transition-all duration-200 rounded-xl ${
            location.pathname === item.url
              ? 'bg-purple-500/30 text-white'
              : 'bg-black text-gray-300 hover:text-white'
          }`}
        >
          <Link to={item.url} onClick={handleLinkClick} className="flex items-center gap-3 px-4 py-3">
            <item.icon className="w-5 h-5" />
            <span className="font-medium">{item.title}</span>
            {item.badge > 0 && (
              <Badge className="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 min-w-[20px] h-5 flex items-center justify-center">
                {item.badge > 99 ? '99+' : item.badge}
              </Badge>
            )}
          </Link>
        </SidebarMenuButton>
      </SidebarMenuItem>
    ))
  );

  return (
    <Sidebar className="border-r">
      <SidebarHeader className="border-b p-6" style={{ borderColor: 'var(--border)' }}>
        <div className="flex items-center gap-3">
          <img
            src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/690097d0394b13206d0558a9/4f3fcb44d_trollcity_featured_1024x500.png"
            alt="TrollCity Logo"
            className="h-10 w-auto object-contain logo-glow"
          />
        </div>
      </SidebarHeader>

      <SidebarContent className="p-3">
        {/* Go Live Button */}
        <SidebarGroup className="mb-4">
          <Link to={createPageUrl("GoLive")} onClick={handleLinkClick}>
            <Button className="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white font-bold gap-2 py-6">
              <Radio className="w-5 h-5" />
              Go Live
            </Button>
          </Link>
        </SidebarGroup>

        {/* Main Navigation */}
        <Collapsible open={openSections.main} onOpenChange={() => toggleSection('main')}>
          <SidebarGroup>
            <CollapsibleTrigger className="w-full">
              <SidebarGroupLabel className="flex items-center justify-between text-gray-400 hover:text-white cursor-pointer px-2 py-2">
                <span className="text-sm font-semibold">Main</span>
                <ChevronDown className={`w-4 h-4 transition-transform ${openSections.main ? 'rotate-180' : ''}`} />
              </SidebarGroupLabel>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <SidebarGroupContent>
                <SidebarMenu>
                  {renderNavItems(mainNavItems)}
                </SidebarMenu>
              </SidebarGroupContent>
            </CollapsibleContent>
          </SidebarGroup>
        </Collapsible>

        {/* Discover Section */}
        <Collapsible open={openSections.discover} onOpenChange={() => toggleSection('discover')}>
          <SidebarGroup>
            <CollapsibleTrigger className="w-full">
              <SidebarGroupLabel className="flex items-center justify-between text-gray-400 hover:text-white cursor-pointer px-2 py-2">
                <span className="text-sm font-semibold">Discover</span>
                <ChevronDown className={`w-4 h-4 transition-transform ${openSections.discover ? 'rotate-180' : ''}`} />
              </SidebarGroupLabel>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <SidebarGroupContent>
                <SidebarMenu>
                  {renderNavItems(discoverNavItems)}
                </SidebarMenu>
              </SidebarGroupContent>
            </CollapsibleContent>
          </SidebarGroup>
        </Collapsible>

        {/* Monetization Section */}
        <Collapsible open={openSections.monetization} onOpenChange={() => toggleSection('monetization')}>
          <SidebarGroup>
            <CollapsibleTrigger className="w-full">
              <SidebarGroupLabel className="flex items-center justify-between text-gray-400 hover:text-white cursor-pointer px-2 py-2">
                <span className="text-sm font-semibold">Earn</span>
                <ChevronDown className={`w-4 h-4 transition-transform ${openSections.monetization ? 'rotate-180' : ''}`} />
              </SidebarGroupLabel>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <SidebarGroupContent>
                <SidebarMenu>
                  {renderNavItems(monetizationNavItems)}
                </SidebarMenu>
              </SidebarGroupContent>
            </CollapsibleContent>
          </SidebarGroup>
        </Collapsible>

        {/* Profile & Settings Section */}
        <Collapsible open={openSections.profile} onOpenChange={() => toggleSection('profile')}>
          <SidebarGroup>
            <CollapsibleTrigger className="w-full">
              <SidebarGroupLabel className="flex items-center justify-between text-gray-400 hover:text-white cursor-pointer px-2 py-2">
                <span className="text-sm font-semibold">Profile & Settings</span>
                <ChevronDown className={`w-4 h-4 transition-transform ${openSections.profile ? 'rotate-180' : ''}`} />
              </SidebarGroupLabel>
            </CollapsibleTrigger>
            <CollapsibleContent>
              <SidebarGroupContent>
                <SidebarMenu>
                  {renderNavItems(profileNavItems)}
                </SidebarMenu>
              </SidebarGroupContent>
            </CollapsibleContent>
          </SidebarGroup>
        </Collapsible>

        {/* Admin/Moderation */}
        {(user?.role === 'admin' || user?.is_troll_officer) && (
          <SidebarGroup>
            <SidebarGroupContent>
              <SidebarMenu>
                <SidebarMenuItem className="mb-1">
                  <SidebarMenuButton
                    asChild
                    className={`hover:bg-cyan-500/20 transition-all duration-200 rounded-xl ${
                      location.pathname === createPageUrl("Admin")
                        ? 'bg-cyan-500/30 text-white'
                        : 'bg-black text-gray-300 hover:text-white'
                    }`}
                  >
                    <Link to={createPageUrl("Admin")} onClick={handleLinkClick} className="flex items-center gap-3 px-4 py-3">
                      <Shield className="w-5 h-5" />
                      <span className="font-medium">
                        {user?.role === 'admin' ? 'Admin' : 'Moderation'}
                      </span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
                <SidebarMenuItem className="mb-1">
                  <SidebarMenuButton
                    asChild
                    className={`hover:bg-blue-500/20 transition-all duration-200 rounded-xl ${
                      location.pathname === createPageUrl("OfficerStream")
                        ? 'bg-blue-500/30 text-white'
                        : 'bg-black text-gray-300 hover:text-white'
                    }`}
                  >
                    <Link to={createPageUrl("OfficerStream")} onClick={handleLinkClick} className="flex items-center gap-3 px-4 py-3">
                      <Radio className="w-5 h-5" />
                      <span className="font-medium">Officer Stream</span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
                <SidebarMenuItem className="mb-1">
                  <SidebarMenuButton
                    asChild
                    className={`hover:bg-purple-500/20 transition-all duration-200 rounded-xl ${
                      location.pathname === createPageUrl("OfficerChat")
                        ? 'bg-purple-500/30 text-white'
                        : 'bg-black text-gray-300 hover:text-white'
                    }`}
                  >
                    <Link to={createPageUrl("OfficerChat")} onClick={handleLinkClick} className="flex items-center gap-3 px-4 py-3">
                      <MessageCircle className="w-5 h-5" />
                      <span className="font-medium">Officer Chat</span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
              </SidebarMenu>
            </SidebarGroupContent>
          </SidebarGroup>
        )}

        {/* Coin Balance */}
        {user && (
          <>
            <SidebarGroup className="mt-4">
              <Link to={createPageUrl("Store")} onClick={handleLinkClick}>
                <div className="px-4 py-3 rounded-xl cursor-pointer hover:bg-yellow-500/10 transition-all" style={{ background: 'rgba(234, 179, 8, 0.1)' }}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-gray-400">My Coins</span>
                    <Coins className="w-4 h-4 text-yellow-400" />
                  </div>
                  <div className="text-2xl font-bold text-yellow-400">
                    {(user.coins || 0).toLocaleString()}
                  </div>
                  <div className="flex items-center gap-3 mt-1 text-xs">
                    <span className="text-green-400 flex items-center gap-1">
                      ‚úì {(user.purchased_coins || 0).toLocaleString()} Troll
                    </span>
                    <span className="text-red-400 flex items-center gap-1">
                      <X className="w-3 h-3" />
                      {(user.free_coins || 0).toLocaleString()} Free
                    </span>
                  </div>
                  <div className="flex items-center justify-between mt-2 pt-2 border-t border-yellow-500/20">
                    <span className="text-xs text-yellow-600">Cash Value:</span>
                    <span className="text-xs text-green-400 font-bold">
                      ${((user.earned_coins || 0) / 160).toFixed(2)}
                    </span>
                  </div>
                  <div className="text-xs text-yellow-600 mt-1 flex items-center gap-1">
                    <ShoppingBag className="w-3 h-3" />
                    Buy More
                  </div>
                </div>
              </Link>
            </SidebarGroup>

            <SidebarGroup className="mt-4">
              <div className="px-4 py-3 rounded-xl" style={{ background: 'rgba(168, 85, 247, 0.1)' }}>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-gray-400">Level & Tier</span>
                  {user.is_troll_officer && (
                    <Badge className="bg-cyan-500 text-white border-0 text-xs">
                      <Shield className="w-3 h-3 mr-1" />
                      Officer
                    </Badge>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <div className={`text-2xl font-bold bg-gradient-to-r ${tierInfo.color} bg-clip-text text-transparent`}>
                    {userLevel}
                  </div>
                  <Badge className={`bg-gradient-to-r ${tierInfo.color} border-0 text-white text-xs`}>
                    Tier {tierInfo.tier}
                  </Badge>
                </div>
              </div>
            </SidebarGroup>
          </>
        )}
      </SidebarContent>

      <SidebarFooter className="border-t p-4" style={{ borderColor: 'var(--border)' }}>
        {user ? (
          <div>
            <div className="flex items-center gap-3 mb-3">
              {user.avatar ? (
                <img
                  src={user.avatar}
                  alt={user.full_name}
                  className="w-10 h-10 rounded-full object-cover"
                />
              ) : (
                <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                  <span className="text-white font-bold text-sm">
                    {user.full_name?.[0]?.toUpperCase() || 'U'}
                  </span>
                </div>
              )}
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-1 flex-wrap">
                  <p className="font-medium text-sm truncate text-gray-200">
                    {user.username ? `@${user.username}` : user.full_name}
                  </p>
                  <OGBadge user={user} className="text-xs px-1 py-0" />
                </div>
                {/* Only show email to admin */}
                {user.role === 'admin' && (
                  <p className="text-xs text-gray-400 truncate">{user.email}</p>
                )}
              </div>
            </div>
            <div className="space-y-2">
              <Button
                onClick={() => base44.auth.logout()}
                variant="outline"
                className="w-full border-red-500/50 text-red-400 hover:bg-red-500/10"
                size="sm"
              >
                Logout
              </Button>
              <Button
                onClick={() => window.location.href = '/#/DeleteAccount'}
                variant="outline"
                className="w-full border-red-500/50 text-red-400 hover:bg-red-500/10 text-xs"
                size="sm"
              >
                Delete Account
              </Button>
            </div>
          </div>
        ) : (
          <div className="text-sm text-gray-400">Loading...</div>
        )}
      </SidebarFooter>
    </Sidebar>
  );
}

export default function Layout({ children }) {
  const [isAgeVerified, setIsAgeVerified] = useState(() => {
    try {
      return localStorage.getItem('age_verified') === 'true';
    } catch (error) {
      console.error("localStorage error:", error);
      return false;
    }
  });
  const [showIOSInstall, setShowIOSInstall] = useState(false);

  const queryClient = useQueryClient();

  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
    retry: false,
  });

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone === true);

  // Enhanced mobile viewport optimization
  useEffect(() => {
    // Remove existing viewport meta tag
    const existingViewport = document.querySelector('meta[name="viewport"]');
    if (existingViewport) {
      existingViewport.remove();
    }

    // Enhanced viewport for ALL mobile devices with better Android support
    const viewport = document.createElement('meta');
    viewport.name = 'viewport';
    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
    document.head.appendChild(viewport);

    if (isIOS) {
      // iOS-specific meta tags
      const webAppCapable = document.createElement('meta');
      webAppCapable.name = 'apple-mobile-web-app-capable';
      webAppCapable.content = 'yes';
      document.head.appendChild(webAppCapable);

      const statusBar = document.createElement('meta');
      statusBar.name = 'apple-mobile-web-app-status-bar-style';
      statusBar.content = 'black-translucent';
      document.head.appendChild(statusBar);

      const appTitle = document.createElement('meta');
      appTitle.name = 'apple-mobile-web-app-title';
      appTitle.content = 'TrollCity';
      document.head.appendChild(appTitle);
    }

    // Enhanced mobile styling - FIXED FOR PC SCROLLING
    const style = document.createElement('style');
    style.innerHTML = `
      * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }
      input, textarea, select {
        -webkit-user-select: text;
        font-size: 16px !important;
      }
      html {
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        height: auto;
      }
      body {
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        min-height: 100vh;
        position: relative;
        overscroll-behavior: none;
      }
      
      /* Android-specific fixes */
      @media (max-width: 768px) {
        body {
          font-size: 16px;
          min-height: 100dvh;
        }
        input, select, textarea {
          font-size: 16px !important;
        }
        
        #root {
          min-height: 100vh;
          min-height: 100dvh;
          display: flex;
          flex-direction: column;
        }
        
        video {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
        }
      }
      
      /* Prevent zoom on double-tap for all mobile devices */
      @media (hover: none) and (pointer: coarse) {
        * {
          touch-action: manipulation;
        }
      }
      
      /* Safe area insets for notched devices */
      @supports (padding: max(0px)) {
        body {
          padding-left: max(0px, env(safe-area-inset-left));
          padding-right: max(0px, env(safe-area-inset-right));
          padding-bottom: max(0px, env(safe-area-inset-bottom));
        }
      }
    `;
    document.head.appendChild(style);

    console.log('‚úÖ Enhanced mobile viewport optimizations applied (iOS + Android)');
  }, [isIOS]);

  // Register Service Worker for PWA
  useEffect(() => {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('‚úÖ Service Worker registered:', registration);
          })
          .catch((error) => {
            console.error('‚ùå Service Worker registration failed:', error);
          });
      });
    }
  }, []);

  // PWA Install Prompt for Android/Desktop
  useEffect(() => {
    let deferredPrompt;

    const handleBeforeInstallPrompt = (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      deferredPrompt = e;

      // Show install banner after 3 seconds if not installed
      const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
      if (!isInstalled && !localStorage.getItem('pwa_install_dismissed')) {
        setTimeout(() => {
          const installBanner = document.createElement('div');
          installBanner.id = 'pwa-install-banner';
          installBanner.className = 'fixed bottom-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-600 to-pink-600 p-4 shadow-2xl';
          installBanner.innerHTML = `
            <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="text-3xl">üì±</div>
                <div>
                  <p class="text-white font-bold text-sm">Install TrollCity App</p>
                  <p class="text-white/90 text-xs">Get the full experience with our app!</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button id="pwa-install-btn" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-100">
                  Install
                </button>
                <button id="pwa-dismiss-btn" class="text-white hover:bg-white/20 px-3 py-2 rounded-lg">
                  ‚úï
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(installBanner);

          document.getElementById('pwa-install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              console.log(`User response: ${outcome}`);
              deferredPrompt = null;
            }
            installBanner.remove();
          });

          document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
            localStorage.setItem('pwa_install_dismissed', 'true');
            installBanner.remove();
          });
        }, 3000);
      }
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  // VPN/IP Detection - ADMIN ONLY, NON-AGGRESSIVE
  useEffect(() => {
    const checkSecurity = async () => {
      if (!user) return;

      try {
        const response = await base44.functions.invoke('detectVPN', {});

        // Only show to admin (no auto-logout for anyone)
        if (user.role === 'admin' && response.data.vpnDetection?.riskScore >= 50) {
          toast.info(`VPN/Proxy detected - Risk: ${response.data.vpnDetection.riskScore}`, {
            duration: 5000
          });
        }
      } catch (error) {
        console.error('Security check failed:', error);
      }
    };

    if (user) {
      checkSecurity();
    }
  }, [user?.id, user?.role]);

  // Device Detection - REMOVED (Allow all devices)

  useEffect(() => {
    const generateUserId = async () => {
      if (!user || user.user_id) return;

      try {
        const userId = `USER-${Math.random().toString(36).substring(2, 11).toUpperCase()}`;
        console.log(`‚úÖ Generating User ID for ${user.email || user.id}: ${userId}`);

        await base44.auth.updateMe({ user_id: userId });
        queryClient.invalidateQueries(['currentUser']);

        console.log(`‚úÖ User ID generated: ${userId}`);
      } catch (error) {
        console.error("‚ùå Failed to generate user ID:", error);
      }
    };

    if (user && !user.user_id) {
      generateUserId();
    }
  }, [user?.id, user?.user_id, queryClient, user]);

  // Initialize coins for new users
  useEffect(() => {
    const initializeCoins = async () => {
      if (!user) return;

      // Check if user has coins initialized (coins should be > 0 or explicitly set)
      const hasCoins = typeof user.coins === 'number';
      const hasFreeCoins = typeof user.free_coins === 'number';
      
      if (!hasCoins || !hasFreeCoins || user.coins === null || user.free_coins === null) {
        try {
          console.log(`üí∞ Initializing coins for new user: ${user.email}`);
          
          await base44.auth.updateMe({
            coins: 1000,
            free_coins: 1000,
            purchased_coins: 0,
            earned_coins: 0
          });
          
          queryClient.invalidateQueries(['currentUser']);
          console.log(`‚úÖ Coins initialized: 1000 free coins`);
        } catch (error) {
          console.error("‚ùå Failed to initialize coins:", error);
        }
      }
    };

    if (user) {
      initializeCoins();
    }
  }, [user?.id, user?.coins, user?.free_coins, queryClient]);

  useEffect(() => {
    if (user && !user.profile_completed) {
      if (!window.location.hash.includes('ProfileSetup')) {
        console.log("üîÑ Redirecting to ProfileSetup - profile not completed");
        window.location.href = '/#/ProfileSetup';
      }
    }
  }, [user?.profile_completed]);

  useEffect(() => {
    if (user?.is_banned) {
      base44.auth.logout();
      window.location.href = '/';
    }
  }, [user?.is_banned]);

  useEffect(() => {
    if (isIOS && !isInStandaloneMode) {
      const hasSeenIOSPrompt = localStorage.getItem('ios_install_seen');
      if (!hasSeenIOSPrompt) {
        setTimeout(() => {
          setShowIOSInstall(true);
        }, 5000);
      }
    }
  }, [isIOS, isInStandaloneMode]);

  const handleAgeVerified = () => {
    setIsAgeVerified(true);
  };

  if (!isAgeVerified) {
    return <AgeVerification onVerified={handleAgeVerified} />;
  }

  return (
    <SidebarProvider>
      <style>{`
        :root {
          --background: #0a0a0f;
          --foreground: #f5f5f7;
          --primary: #ff0844;
          --primary-hover: #cc0636;
          --accent-cyan: #00ff88;
          --accent-pink: #ff0844;
          --card-bg: #1a0f14;
          --border: #3a1a24;
        }

        body {
          touch-action: pan-x pan-y;
          background: linear-gradient(135deg, #0a0a0f 0%, #1a0514 25%, #0f0a0f 50%, #14050f 75%, #0a0a0f 100%);
          background-attachment: fixed;
          color: var(--foreground);
          overscroll-behavior: none;
        }

        /* Prevent zoom on input focus - critical for Android */
        input, select, textarea, button {
          font-size: 16px !important;
        }

        /* FIXED: Allow scrolling on PC and mobile */
        html, body {
          width: 100%;
          overflow-x: hidden;
          overflow-y: auto;
        }

        /* Mobile-specific layout fixes */
        @media (max-width: 768px) {
          .min-h-screen {
            min-height: 100vh;
            min-height: 100dvh;
          }
        }

        @media (display-mode: standalone) {
          body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
          }
        }

        .neon-troll {
          color: #00ff88;
          text-shadow:
            0 0 10px #00ff88,
            0 0 20px #00ff88,
            0 0 30px #00ff88,
            0 0 40px #00ff88;
          animation: neon-pulse 2s ease-in-out infinite;
        }

        .neon-red {
          color: #ff0844;
          text-shadow:
            0 0 10px #ff0844,
            0 0 20px #ff0844,
            0 0 30px #ff0844,
            0 0 40px #ff0844;
          animation: neon-pulse 2s ease-in-out infinite;
        }

        @keyframes neon-pulse {
          0%, 100% {
            text-shadow:
              0 0 10px currentColor,
              0 0 20px currentColor,
              0 0 30px currentColor,
              0 0 40px currentColor;
          }
          50% {
            text-shadow:
              0 0 15px currentColor,
              0 0 30px currentColor,
              0 0 45px currentColor,
              0 0 60px currentColor,
              0 0 75px currentColor;
          }
        }

        .logo-glow {
          filter: drop-shadow(0 0 10px rgba(0, 255, 136, 0.7)) drop-shadow(0 0 20px rgba(255, 8, 68, 0.5));
        }

        /* Neon border glow effects */
        .neon-border-green {
          border-color: #00ff88;
          box-shadow: 0 0 10px rgba(0, 255, 136, 0.5), inset 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .neon-border-red {
          border-color: #ff0844;
          box-shadow: 0 0 10px rgba(255, 8, 68, 0.5), inset 0 0 10px rgba(255, 8, 68, 0.2);
        }

        /* Sidebar styling */
        [data-sidebar] {
          background: linear-gradient(180deg, #1a0f14 0%, #0f0a0f 50%, #0a0f14 100%);
          border-right: 2px solid rgba(0, 255, 136, 0.3);
        }

        /* Card backgrounds with neon theme */
        .bg-card {
          background: linear-gradient(135deg, rgba(26, 15, 20, 0.9) 0%, rgba(15, 10, 15, 0.9) 100%);
          border: 1px solid rgba(0, 255, 136, 0.2);
        }
      `}</style>

      {showIOSInstall && (
        <div className="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-blue-600 to-purple-600 p-4 shadow-2xl">
          <div className="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="text-3xl">üì±</div>
              <div>
                <p className="text-white font-bold text-sm">Install TrollCity App</p>
                <p className="text-white/90 text-xs flex items-center gap-1">
                  Tap <svg className="w-4 h-4 inline mx-1" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg> ‚Üí "Add to Home Screen"
                </p>
              </div>
            </div>
            <Button
              onClick={() => {
                setShowIOSInstall(false);
                localStorage.setItem('ios_install_seen', 'true');
              }}
              variant="ghost"
              size="sm"
              className="text-white hover:bg-white/20 flex-shrink-0"
            >
              ‚úï
            </Button>
          </div>
        </div>
      )}

      <div className="min-h-screen flex w-full" style={{ paddingTop: showIOSInstall ? '80px' : '0' }}>
        <SidebarContentComponent user={user} />

        <main className="flex-1 flex flex-col overflow-y-auto">
          <header className="border-b px-6 py-4 md:hidden neon-border-green" style={{ background: 'linear-gradient(90deg, rgba(26, 15, 20, 0.95) 0%, rgba(15, 26, 15, 0.95) 100%)' }}>
            <div className="flex items-center gap-4">
              <SidebarTrigger className="hover:bg-[#00ff88]/10 p-2 rounded-lg transition-colors duration-200" />
              <img
                src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/690097d0394b13206d0558a9/4f3fcb44d_trollcity_featured_1024x500.png"
                alt="TrollCity Logo"
                className="h-8 w-auto object-contain logo-glow"
              />
            </div>
          </header>

          <div className="flex-1">
            {children}
          </div>

          <footer className="border-t px-6 py-4 text-center neon-border-red" style={{ background: 'linear-gradient(90deg, rgba(26, 15, 20, 0.95) 0%, rgba(26, 10, 15, 0.95) 100%)' }}>
            <div className="flex flex-col gap-2">
              <p className="text-xs text-gray-400">
                ¬© {new Date().getFullYear()} <span className="neon-troll font-semibold">Troll</span><span className="neon-red font-semibold">City</span>. All Rights Reserved.
              </p>
              <p className="text-xs text-red-400 font-semibold">
                ‚ö†Ô∏è Copyright Infringement is a Crime. Unauthorized use of content is strictly prohibited.
              </p>
              <p className="text-xs text-gray-500">
                All content on this platform is protected by copyright law.
              </p>
              <p className="text-xs text-gray-600 mt-2">
                üí¨ Need help? <button onClick={() => window.location.href = `/#/Messages`} className="text-purple-400 hover:text-purple-300 underline">Message Admin</button>
              </p>
            </div>
          </footer>
        </main>
      </div>
    </SidebarProvider>
  );
}
