import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    // Verify user is authenticated
    const user = await base44.auth.me();
    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { streamId } = await req.json();

    if (!streamId) {
      return Response.json({ error: 'Stream ID required' }, { status: 400 });
    }

    // Update heartbeat
    await base44.entities.Stream.update(streamId, {
      last_heartbeat: new Date().toISOString()
    });

    // Clean up stale streams (no heartbeat in last 2 minutes)
    const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
    const allLiveStreams = await base44.asServiceRole.entities.Stream.filter({ status: 'live' });
    
    for (const stream of allLiveStreams) {
      if (stream.last_heartbeat && stream.last_heartbeat < twoMinutesAgo) {
        // End stale stream
        await base44.asServiceRole.entities.Stream.update(stream.id, { 
          status: 'ended',
          viewer_count: 0
        });
        
        // Delete IVS channel if exists
        if (stream.ivs_channel_arn) {
          try {
            await base44.asServiceRole.functions.invoke('manageIVS', {
              action: 'deleteChannel',
              channel_arn: stream.ivs_channel_arn
            });
          } catch (error) {
            console.error('Failed to delete IVS channel:', error);
          }
        }
      }
    }

    return Response.json({ 
      success: true,
      cleaned: allLiveStreams.filter(s => s.last_heartbeat && s.last_heartbeat < twoMinutesAgo).length
    });

  } catch (error) {
    console.error('Heartbeat error:', error);
    return Response.json({ 
      error: error.message || 'Failed to process heartbeat' 
    }, { status: 500 });
  }
});